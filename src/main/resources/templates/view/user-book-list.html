<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì „ì²´ ëª©ë¡</title>
    <link rel="stylesheet" href="/css/user-style.css">
    <script>
        /**
         * 'ë‚˜ì˜ ë„ì„œ ëª©ë¡'ìœ¼ë¡œ í˜ì´ì§€ë¥¼ ì´ë™í•©ë‹ˆë‹¤.
         */
        function navigateToMyBook() {
            window.location.href = '/user/my-book';
        }

        /**
         * ëŒ€ì¶œ ë²„íŠ¼ì„ í´ë¦­ ì‹œ, ì‚¬ìš©ì í™•ì¸ì„ ë°›ê³  ì„œë²„ì— ëŒ€ì¶œ ìš”ì²­ì„ ì „ì†¡í•©ë‹ˆë‹¤.
         *
         * @param {HTMLElement} button - í´ë¦­ëœ ëŒ€ì¶œ ë²„íŠ¼ ìš”ì†Œ
         */
        function bookLoanSubmit(button) {
            const bookItem = button.closest('.book-item');
            const bookId = bookItem.dataset.bookId;
            const bookName = bookItem.dataset.bookName;

            let confirmMessage = "[" + bookName + "]ì„(ë¥¼) ëŒ€ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
            if(confirm(confirmMessage)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "/user/loan/" + bookId;

                document.body.appendChild(form);
                form.submit();
            }
        }

        /**
         * ì˜ˆì•½ ë²„íŠ¼ì„ í´ë¦­ ì‹œ, ì‚¬ìš©ì í™•ì¸ì„ ë°›ê³  ì„œë²„ì— ì˜ˆì•½ ìš”ì²­ì„ ì „ì†¡í•©ë‹ˆë‹¤.
         *
         * @param {HTMLElement} button - í´ë¦­ëœ ëŒ€ì¶œ ë²„íŠ¼ ìš”ì†Œ
         */
        function bookReserveSubmit(button) {
            const bookItem = button.closest('.book-item');
            const bookId = bookItem.dataset.bookId;
            const bookName = bookItem.dataset.bookName;

            let confirmMessage = "[" + bookName + "]ì„(ë¥¼) ì˜ˆì•½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
            if(confirm(confirmMessage)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "/user/reserve/" + bookId;

                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
    <script th:inline="javascript">

        /**
         * [[${best}]] ëŠ” ì£¼ì„ì´ ì•„ë‹ˆë¼ Thymeleaf í‘œí˜„ì‹ìœ¼ë¡œ,
         * ì„œë²„ì—ì„œ ì „ë‹¬ëœ best ë³€ìˆ˜ ê°’ì´ ìë°”ìŠ¤í¬ë¦½íŠ¸ ë°°ì—´ë¡œ ì‚½ì…ë©ë‹ˆë‹¤.
         */
        let bestBooks = /*[[${best}]]*/ [];


        /**
         * bestBooks ë°°ì—´ì„ ê¸°ë°˜ìœ¼ë¡œ select-book ê³¼ rank-book <div> ë¥¼ ëœë”ë§í•©ë‹ˆë‹¤.
         */
        function updateBestBooksView() {
            const selectBookContainer = document.querySelector('.select-book');
            const rankBookContainer = document.querySelector('.rank-book');
            renderSelectBook(selectBookContainer);
            renderRankBooks(rankBookContainer);
        }

        /**
         * bestBooks ë°°ì—´ì˜ ì²«ë²ˆì§¸ ìš”ì†Œë¥¼ select-book ì— innerHtml ë¡œ ì‚½ì…í•©ë‹ˆë‹¤.
         */
        function renderSelectBook(container) {
            const firstBook = bestBooks[0];
            container.innerHTML = `
                <img src="${firstBook.imgPath}" alt="book image" class="select-book-img">
                <div class="select-book-info">
                    <span>${firstBook.bookRank}</span>
                    <span>${firstBook.bookName}</span>
                    <span>${firstBook.author}</span>
                </div>
            `;

        }

        /**
         * bestBooks.slice(1) ë¥¼ í†µí•´ bestBooks ë°°ì—´ì˜ ì²«ë²ˆì§¸ ìš”ì†Œë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ìš”ì†Œë¥¼
         * join('') ìœ¼ë¡œ ì—°ê²°í•˜ì—¬ rank-book ì— innerHtml ë¡œ ì‚½ì…í•©ë‹ˆë‹¤.
         */
        function renderRankBooks(container) {
            container.innerHTML = bestBooks.slice(1).map(book => `
                <div class="rank-book-item">
                    <span class="rank-number">${book.bookRank}</span>
                    <img src="${book.imgPath}" alt="book image" class="rank-book-img">
                </div>
            `).join('');
        }

        /**
         * ë°°ì—´ì˜ ì²«ë²ˆì§¸ ìš”ì†Œë¥¼ ë§¨ ë’¤ë¡œ ì´ë™ì‹œí‚¨ í›„
         * updateBestBooksView() ë¥¼ í˜¸ì¶œí•˜ì—¬ í™”ë©´ì„ ë‹¤ì‹œ ëœë”ë§í•©ë‹ˆë‹¤.
         */
        function rotateRight() {
            bestBooks.push(bestBooks.shift());
            updateBestBooksView();
        }

        /**
         * HTML ë¬¸ì„œì˜ DOM êµ¬ì¡°ë§Œ ì¤€ë¹„ë˜ì—ˆì„ ë•Œ updateBestBooksView()ë¥¼ í˜¸ì¶œí•˜ì—¬
         * select-book ê³¼ rank-book <div> ë¥¼ ëœë”ë§í•©ë‹ˆë‹¤.
         */
        document.addEventListener('DOMContentLoaded', () => {
            updateBestBooksView();
        });

        /* TODO [ê³µë¶€] DOMContentLoaded ë°©ì‹ê³¼ ìŠ¤í¬ë¦½íŠ¸ ë°©ì‹ì˜ ì°¨ì´
        â€» addEventListener('click', (e) => {...}): ì„ íƒí•œ ìš”ì†Œì— íŠ¹ì • ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ë•Œ ì‹¤í–‰ë  í•¨ìˆ˜ë¥¼ ë“±ë¡.
                                                    document ëŠ” ì›¹ í˜ì´ì§€ì˜ HTML ë¬¸ì„œë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´ë¡œ document.addEventListener()ë¥¼ ì‚¬ìš©í•˜ë©´,
                                                    HTML ë¬¸ì„œ ì „ì²´ì—ì„œ ë°œìƒí•˜ëŠ” ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•  ìˆ˜ ìˆë‹¤.
        â€» DOMContentLoaded:  ë¸Œë¼ìš°ì €ê°€ HTML ë¬¸ì„œë¥¼ ì™„ì „íˆ ë¡œë“œí•˜ê³  DOM íŠ¸ë¦¬ë¥¼ ìƒì„±í–ˆì„ ë•Œ ë°œìƒ
                             (CSS ë‚˜ ì´ë¯¸ì§€ ê°™ì€ ë¦¬ì†ŒìŠ¤ì˜ ë¡œë“œê°€ ì™„ë£Œë˜ë¥¼ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  DOM êµ¬ì¡°ë§Œ ë¡œë“œë˜ë©´ ì‹¤í–‰)
        * */
    </script>
</head>
<body>
<div class="container">
<div class="wrap-container">

    <div class="header">
        <form class="user-nav" action="/logout" method="post">
            <button th:text="${userInfo}" class="user-nav-name"></button>
            <span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤ ! ğŸ¤—</span>
            <button class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
        </form>
        <div class="domain-title">
            <span>ë„ì„œê´€ë¦¬ ì–´í”Œë¦¬ì¼€ì´ì…˜</span>
        </div>
    </div>

    <div class="menu-nav">
        <div class="category-nav">
            <button disabled>ì „ì²´ ë„ì„œ ëª©ë¡</button>
            <button onclick="navigateToMyBook()">ë‚˜ì˜ ë„ì„œ ëª©ë¡</button>
        </div>
        <form action="/user/library" method="GET" class="search-book">
            <input name="keyword" placeholder="ë„ì„œëª… ê²€ìƒ‰">
            <button type="submit">
                <img src="/img/glass.png" alt="book image" class="search-img">
            </button>
        </form>
    </div>

    <div class="book-list-container">

        <div class="book-list-area">
            <div th:each="book : ${books}" class="book-item"
                 th:data-book-id="${book.bookId}" th:data-book-name="${book.bookName}">
                <img th:src="${book.imgPath}" alt="book image" class="book-item-img">
                <div class="book-item-info">
                    <div>
                        <span th:text="${book.bookName}" class="book-item-title"></span>
                    </div>
                    <div class="book-item-etc">
                        <span th:text="${book.author}"></span> Â·
                        <span th:text="${book.publisher}"></span> Â·
                        <span th:text="${book.publishedAt}"></span>
                    </div>
                    <div class="book-item-status">
                        <span>ëŒ€ì¶œ ê°€ëŠ¥ ì—¬ë¶€: </span>
                        <span th:if="${book.isBorrowed and !book.amIBorrower}" th:text="'ëŒ€ì¶œ ì¤‘'"></span>
                        <span th:if="${book.amIBorrower}" th:text="|ëŒ€ì¶œ ì¤‘ (${userInfo})|"></span>
                        <span th:if="${!book.isBorrowed and !book.amIBorrower}" th:text="'ëŒ€ì¶œ ê°€ëŠ¥'"></span>
                        <span>&nbsp; | &nbsp; ì˜ˆì•½: </span>
                        <span th:if="${!book.isAlreadyReserved}" th:text="|${book.totalReservations} ëª…|"></span>
                        <span th:if="${book.isAlreadyReserved}" th:text="|ì˜ˆì•½ë¨ (${userInfo})|"></span>
                    </div>
                </div>
                <div class="book-item-btn-area">
                    <!-- ëŒ€ì¶œì´ ê°€ëŠ¥í•˜ë ¤ë©´ -->
                    <!-- ëŒ€ì¶œì´ ë¶ˆê°€ëŠ¥í•œ ìƒí™© 1. ëŒ€ì¶œ ì¤‘ ì¸ê²½ìš°, 2. ì˜ˆì•½ìê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš° -->
                    <button th:disabled="${book.isBorrowed} or ${book.totalReservations} > 0"
                            onclick="bookLoanSubmit(this)"
                            class="book-item-btn">ëŒ€ì—¬</button>
                    <!-- ì˜ˆì•½ì´ ê°€ëŠ¥í•˜ë ¤ë©´ -->
                    <!-- ì˜ˆì•½ì´ ë¶ˆê°€ëŠ¥í•œ ìƒí™© 1. ëŒ€ì¶œì´ ê°€ëŠ¥í•œ ê²½ìš°, 2. ë‚´ê°€ ëŒ€ì¶œì¤‘ì¸ ê²½ìš° 3. ë‚´ê°€ ì˜ˆì•½ì¤‘ì¸ ê²½ìš° -->
                    <button th:disabled="(${not book.isBorrowed and book.totalReservations == 0}) or ${book.amIBorrower} or ${book.isAlreadyReserved}"
                            onclick="bookReserveSubmit(this)"
                            class="book-item-btn">ì˜ˆì•½</button>
                </div>
            </div>

            <div th:if="${#lists.isEmpty(books)}" class="no-book-result">
                <img src="/img/no-result.png" alt="warn image" class="no-result-img" >
                <span>' <span th:text="${keyword}"></span> ' ë„ì„œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
                <span>ê²€ìƒ‰ì–´ì˜ ì² ìê°€ ì •í™•í•œì§€ ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸í•´ì£¼ì„¸ìš”.</span>
            </div>
        </div>

        <div class="best-book-area">
            <div class="best-book-area-title">
                <span>ë² ìŠ¤íŠ¸ âœ¨ </span>
                <button class="next-book-btn" onclick="rotateRight()"> ã€‰</button>
            </div>
            <div class="select-book"></div>
            <div class="rank-book"></div>
        </div>

    </div>

</div>
</div>
</body>
</html>