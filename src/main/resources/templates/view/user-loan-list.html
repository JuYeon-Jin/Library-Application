<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ëŒ€ì—¬ ëª©ë¡</title>
    <link rel="stylesheet" href="/css/user-style.css">
    <script>

        /**
         * 'ë„ì„œ ì „ì²´ ëª©ë¡'ìœ¼ë¡œ í˜ì´ì§€ë¥¼ ì´ë™í•©ë‹ˆë‹¤.
         */
        function navigateToLibrary() {
            window.location.href = '/user/library';
        }


        /**
         * ì˜ˆì•½ì·¨ì†Œ ë²„íŠ¼ì„ í´ë¦­ ì‹œ, ì‚¬ìš©ì í™•ì¸ì„ ë°›ê³  ì„œë²„ì— ì·¨ì†Œ ìš”ì²­ì„ ì „ì†¡í•©ë‹ˆë‹¤.
         *
         * @param {HTMLElement} button - í´ë¦­ëœ ëŒ€ì¶œ ë²„íŠ¼ ìš”ì†Œ
         */
        function bookReserveCancel(button) {
            const bookItem = button.closest('.reservation-book-item');
            const reservationId = bookItem.dataset.reservationId;
            const bookName = bookItem.dataset.bookName;

            let confirmMessage = "[" + bookName + "]ì˜ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
            if(confirm(confirmMessage)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/user/reserve/' + reservationId;

                const methodInput = document.createElement('input');
                methodInput.type = 'hidden';
                methodInput.name = '_method';
                methodInput.value = 'DELETE';

                form.appendChild(methodInput);
                document.body.appendChild(form);
                form.submit();
            }
        }


        /**
         * ëŒ€ì¶œ ë²„íŠ¼ì„ í´ë¦­ ì‹œ, ì‚¬ìš©ì í™•ì¸ì„ ë°›ê³  ì„œë²„ì— ëŒ€ì¶œ ìš”ì²­ì„ ì „ì†¡í•©ë‹ˆë‹¤.
         *
         * @param {HTMLElement} button - í´ë¦­ëœ ëŒ€ì¶œ ë²„íŠ¼ ìš”ì†Œ
         */
        function bookLoanSubmit(button) {
            const bookItem = button.closest('.reservation-book-item');
            const reservationId = bookItem.dataset.reservationId;
            const bookName = bookItem.dataset.bookName;

            let confirmMessage = "[" + bookName + "]ì„(ë¥¼) ëŒ€ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
            if(confirm(confirmMessage)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/user/reserve/loan/' + reservationId;

                document.body.appendChild(form);
                form.submit();
            }
        }


        /**
         * ë°˜ë‚© ë²„íŠ¼ì„ í´ë¦­ ì‹œ, ì‚¬ìš©ì í™•ì¸ì„ ë°›ê³  ì„œë²„ì— ë°˜ë‚© ìš”ì²­ì„ ì „ì†¡í•©ë‹ˆë‹¤.
         *
         * @param {HTMLElement} button - í´ë¦­ëœ ëŒ€ì¶œ ë²„íŠ¼ ìš”ì†Œ
         */
        function bookLoanReturn(button) {
            const bookItem = button.closest('.loan-book-item');
            const loanId = bookItem.dataset.loanId;
            const bookName = bookItem.dataset.bookName;

            let confirmMessage = "[" + bookName + "]ì„(ë¥¼) ë°˜ë‚©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
            if(confirm(confirmMessage)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "/user/loan/" + loanId;

                const methodInput = document.createElement('input');
                methodInput.type = 'hidden';
                methodInput.name = '_method';
                methodInput.value = 'PUT';

                form.appendChild(methodInput);
                document.body.appendChild(form);
                form.submit();
            }
        }


        /**
         * í˜ì´ì§€ì˜ ìµœìƒë‹¨ìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤í•©ë‹ˆë‹¤.
         * ì´ í•¨ìˆ˜ëŠ” ì‚¬ìš©ìê°€ "ë§¨ ìœ„ë¡œ ì´ë™" ë²„íŠ¼ì„ í´ë¦­í–ˆì„ ë•Œ í˜¸ì¶œë©ë‹ˆë‹¤.
         */
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth'
            });
        }

    </script>
    <script>

        // TODO [ê³µë¶€] DOMContentLoaded ì™€ onmouseover ë¹„êµí•˜ê¸°

        /**
         * í˜ì´ì§€ê°€ ë¡œë“œëœ í›„ "ì˜ˆì•½ ë„ì„œ"ì™€ "ëŒ€ì¶œ ë„ì„œ"ì— íˆ´íŒì„ í‘œì‹œí•˜ëŠ” ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
         * ë§ˆìš°ìŠ¤ê°€ ì˜¬ë¼ê°„(mouseover) ê²½ìš°ì— íˆ´íŒì´ í‘œì‹œë˜ê³ ,
         * ë§ˆìš°ìŠ¤ê°€ ë– ë‚  ë•Œ(mouseleave) íˆ´íŒì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.
         */
        document.addEventListener("DOMContentLoaded", function () {
            const reserveTooltip = document.getElementById("tooltip-reserve");
            const loanTooltip = document.getElementById("tooltip-loan");
            let tooltip;

            document.addEventListener("mouseover", function (event) {
                const target = event.target.closest(".my-book-title");
                if (target) {
                    const bookName = target.querySelector("span").innerText;

                    if (target.closest(".reservation-book-item")) {
                        tooltip = reserveTooltip;
                    } else if (target.closest(".loan-book-item")) {
                        tooltip = loanTooltip;
                    }

                    if (tooltip) {
                        tooltip.innerText = bookName;
                        tooltip.classList.add("show");

                        const rect = target.getBoundingClientRect();
                        // TODO [ê³µë¶€] position: fixed VS position: absolute(window.scrollX) ë¹„êµí•˜ê¸°
                        let left = rect.left;
                        let top = rect.top;

                        const tooltipWidth = tooltip.offsetWidth;
                        const windowWidth = window.innerWidth;

                        if (left + tooltipWidth > windowWidth) {
                            left = rect.right - tooltipWidth + 15;
                        }

                        tooltip.style.left = `${left-10}px`;
                        tooltip.style.top = `${top-2}px`;

                        tooltip.addEventListener("mouseleave", function () {
                            tooltip.classList.remove("show");
                        });
                    }
                }
            });
        });

    </script>
</head>
<body>
<div class="container">
<div class="wrap-container">

    <div class="header">
        <form class="user-nav" action="/logout" method="post">
            <button th:text="${userInfo}" class="user-nav-name"></button>
            <span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤ ! ğŸ¤—</span>
            <button class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
        </form>
        <div class="domain-title">
            <span>ë„ì„œê´€ë¦¬ ì–´í”Œë¦¬ì¼€ì´ì…˜</span>
        </div>
    </div>

    <div class="menu-nav">
        <div class="category-nav">
            <button onclick="navigateToLibrary()">ì „ì²´ ë„ì„œ ëª©ë¡</button>
            <button disabled>ë‚˜ì˜ ë„ì„œ ëª©ë¡</button>
        </div>
    </div>

    <div class="my-book-container">

        <div class="my-book-menu-title">
            <span>âœ¨ ì˜ˆì•½ ë„ì„œ (<span th:text="${#lists.size(reservation)}"></span>/6)</span>
        </div>
        <div class="book-reservation-area">
            <div th:each="book : ${reservation}" class="reservation-book-item"
                 th:data-reservation-id="${book.reservationId}" th:data-book-name="${book.bookName}">
                <div class="my-book-info">
                    <img th:src="${book.imgPath}" alt="book image" class="my-book-img">
                    <div class="my-book-etc">
                        <div class="my-book-title">
                            <span th:text="${book.bookName}"></span>
                        </div>
                        <div id="tooltip-reserve" class="tooltip"></div>
                        <div class="book-item-etc">
                            <span th:text="${book.publisher}"></span>
                        </div>
                        <div class="reservation-date">
                            ì˜ˆì•½ ìš”ì²­ì¼ : <span th:text="${book.reservedAt}" class="highlight-data"></span>
                        </div>
                        <div class="reservation-queue-count">
                            <span th:if="${book.waitingRank > 0}">
                                ì˜ˆì•½ ëŒ€ê¸°ì : &nbsp;&nbsp;<span th:text="${book.waitingRank}" class="highlight-data"></span> ëª…
                            </span>
                            <span th:if="${book.waitingRank == 0 and book.isReturned == false}" class="highlight-data">
                                âŒ› ë„ì„œ ë°˜ë‚© ëŒ€ê¸° ì¤‘
                            </span>
                            <span th:if="${book.waitingRank == 0 and book.isReturned == true}" class="highlight-data">
                                ğŸ‘ ëŒ€ì¶œ ê°€ëŠ¥
                            </span>
                        </div>
                    </div>
                </div>
                <div class="my-book-btn-area">
                    <button onclick="bookReserveCancel(this)" class="book-item-btn">ì˜ˆì•½ì·¨ì†Œ</button>
                    <button onclick="bookLoanSubmit(this)" class="book-item-btn"
                            th:disabled="${book.waitingRank != 0} or ${book.isReturned != true}">ëŒ€ì—¬</button>
                </div>
            </div>
            <div th:if="${#lists.isEmpty(reservation)}" class="no-my-book-result">
                <span>ì˜ˆì•½ì¤‘ì¸ ë„ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</span>
            </div>
        </div> <!-- end.book-reservation-area -->

        <div class="my-book-menu-title">
            <span>âœ¨ ëŒ€ì¶œ ë„ì„œ (<span th:text="${#lists.size(loan)}"></span>/6)</span>
        </div>
        <div class="book-loan-area">
            <div th:each="book : ${loan}"  class="loan-book-item"
                 th:data-loan-id="${book.loanId}" th:data-book-name="${book.bookName}">
                <div class="my-book-info">
                    <img th:src="${book.imgPath}" alt="book image" class="my-book-img">
                    <div class="my-book-etc">
                        <div class="my-book-title">
                            <span th:text="${book.bookName}"></span>
                        </div>
                        <div id="tooltip-loan" class="tooltip"></div>
                        <div class="book-item-etc">
                            <span th:text="${book.publisher}"></span>
                        </div>
                        <div class="reservation-date">
                            ëŒ€ì¶œ ì‹œì‘ì¼ :
                            <span th:text="${book.borrowedAt}" class="highlight-data"></span>
                        </div>
                        <div class="reservation-queue-count">
                            ëŒ€ì¶œ ì¢…ë£Œì¼ :
                            <span th:text="${book.dueDate}" th:class="${book.overdueDays > 0} ? 'alert-data' : 'highlight-data'"></span>
                        </div>
                        <div class="reservation-queue-count">
                            ì—°ì²´ì¼: &nbsp;&nbsp;
                            <span th:text="${book.overdueDays}" th:class="${book.overdueDays > 0} ? 'alert-data' : 'highlight-data'"></span> ì¼
                        </div>
                    </div>
                </div>
                <div class="my-book-btn-area">
                    <button onclick="bookLoanReturn(this)" class="book-item-btn">ë°˜ë‚©</button>
                </div>
            </div>
            <div th:if="${#lists.isEmpty(loan)}" class="no-my-book-result">
                <span>ëŒ€ì¶œì¤‘ì¸ ë„ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</span>
            </div>
        </div> <!-- end.book-loan-area -->

    </div>

    <div class="navigation-button-area">
        <button id="scrollToTopButton" class="page-up-btn" onclick="scrollToTop()">
            ë§¨ ìœ„ë¡œ ì´ë™
            <img src="/img/up.png" class="page-up-img" alt="Page Up Icon">
        </button>
    </div>

</div>
</div>
</body>
</html>